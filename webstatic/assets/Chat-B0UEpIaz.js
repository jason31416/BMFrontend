import{r,o as W,k as E,a as $,c as l,j as _,f as a,g as v,F as w,d as T,e as g,w as C,T as N,l as M,v as U,u as A,m as P,p as D,q as J,b as o,s as z,t as h,x as Q,y as Y}from"./index-TIiU0LZt.js";import{N as Z}from"./NavBar-C0FAO5nD.js";import{a as k,_ as y}from"./const-ClyfiBNT.js";const ee={class:"chat-main"},te={class:"sidebar"},se={key:0,class:"server-status-panel"},ae={class:"server-header"},ne={class:"online-count"},le=["onClick"],oe={class:"player-list-container"},re={class:"player-list"},ie=["href"],ce=["hidden"],ue={class:"message-header"},de={key:0,class:"systemmessage"},pe=["href"],ve={class:"timestamp"},he={key:0},fe={key:0,class:"message-content"},me={key:0,class:"input-wrapper"},ge={key:1,class:"input-wrapper"},xe={__name:"Chat",setup(ye){J();const f=r([]),m=r(null),u=r([]),p=r(!1),I=r(!1),x=r(null),F=r(null),X=r(!0),b=r(!1),H=r("global");var c=r("");const S=r(!0),L=async n=>{if(!(p.value||I.value)){p.value=!0;try{const s={limit:15};n&&(s.before=n);const e=await k.get(y.backendurl+"/api/messages",{params:s});if(e.data.length===0){I.value=!0;return}if(n){const t=m.value,d=t.scrollHeight;u.value.unshift(...e.data.reverse()),await D(),t.scrollTop=t.scrollHeight-d}else{const t=m.value,d=t.scrollHeight;u.value=e.data.reverse(),await D(),t.scrollTop=t.scrollHeight-d}}finally{p.value=!1}}},j=()=>{if(m.value.scrollTop<100&&!p.value){const s=u.value[0];s&&L(s.createdAt)}},O=()=>{x.value=setInterval(async()=>{try{const n={limit:15};n.after=u.value[u.value.length-1].createdAt;const s=await k.get(y.backendurl+"/api/messages",{params:n});if(s.data.length>0){const e=m.value;u.value.push(...s.data),F.value=u.value[u.value.length-1].createdAt,e.scrollTop+e.offsetHeight>=e.scrollHeight-100&&(await D(),e.scrollTop=e.scrollHeight)}}catch(n){console.error("Failed to fetch updates:",n)}},1e3)},R=n=>new Date(n).toLocaleString();W(()=>{window.innerWidth<1300&&(S.value=!1),E.isKey("bmsessiontoken")&&(b.value=!0),p.value=!0,setTimeout(()=>{p.value=!1,L()},200),O(),setTimeout(B,200),setInterval(()=>{B()},5e3)}),$(()=>{x.value&&clearInterval(x.value)});function q(){k.post(y.backendurl+"/api/sendchat",{token:E.get("bmsessiontoken"),message:c.value}).then(n=>{n.data.success==!0&&(c.value="")})}function V(n,s){const e=f.value.find(t=>t.name===n);if(e){const t={id:Date.now(),name:s,state:"enter"};e.players.push(t)}}function G(n,s){const e=f.value.find(t=>t.name==n);if(e){const t=e.players.find(d=>d.name==s);t&&(t.state="exit",setTimeout(()=>{e.players=e.players.filter(d=>d.name!=s)},300))}}const B=async()=>{try{k.get(y.backendurl+"/api/serverstatus").then(n=>{const s=n.data;console.log(s),s.forEach(e=>{const t=f.value.find(i=>i.name===e.name);if(!t){f.value.push({name:e.name,status:e.status,players:[],collapsed:!0,lastChecked:new Date().toISOString()}),e.status&&e.players.forEach(i=>{V(e.name,i)});return}if(t.status=e.status,t.lastChecked=new Date().toISOString(),e.players.length==0&&collapseServer(t.name),!e.status)return;const d=new Set(t.players.map(i=>i.name)),K=new Set(e.players);e.players.forEach(i=>{d.has(i)||V(t.name,i)}),t.players.forEach(i=>{K.has(i.name)||G(t.name,i.name)})})})}catch(n){console.error("Server status update failed:",n)}};return(n,s)=>(o(),l(w,null,[_(Z,{visible:X.value},null,8,["visible"]),a("main",ee,[a("div",te,[S.value?(o(),l("div",se,[(o(!0),l(w,null,T(f.value,e=>(o(),l("div",{key:e.name,class:"server-card"},[a("div",ae,[a("div",{class:g(["status-indicator",{running:e.status}])},null,2),a("h3",null,[z(h(e.name)+" ",1),a("span",ne,"在线 "+h(e.players.length),1)]),a("button",{class:"collapse-btn",onClick:t=>e.collapsed=e.players.length>0?!e.collapsed:!0},[(o(),l("svg",{class:g({rotated:!e.collapsed}),width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"#94a3b8","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},s[3]||(s[3]=[a("path",{d:"M6 9l6 6 6-6"},null,-1)]),2))],8,le)]),_(Y,{name:"slide"},{default:C(()=>[M(a("div",oe,[a("div",re,[_(N,{name:"player"},{default:C(()=>[(o(!0),l(w,null,T(e.players,t=>(o(),l("div",{key:t.id,class:g(["player-item",t.state])},[a("a",{href:"/user/"+t.name,class:"player-name"},h(t.name),9,ie)],2))),128))]),_:2},1024)])],512),[[Q,!e.collapsed]])]),_:2},1024)]))),128))])):v("",!0)]),a("div",{class:"chat-container",ref_key:"chatContainer",ref:m,onScroll:j},[p.value?(o(),l("div",{key:0,class:g(["loading-indicator",{loading:p.value}])},s[4]||(s[4]=[a("div",{class:"loading-spinner"},[a("div"),a("div"),a("div")],-1)]),2)):v("",!0),_(N,{name:"message",tag:"div",class:"messages"},{default:C(()=>[(o(!0),l(w,null,T(u.value,e=>(o(),l("div",{class:g([{selfMessage:e.username==y.username.value},"message"]),key:e.id,hidden:e.server!=H.value&&H.value!="global"},[a("div",ue,[e.type=="server"?(o(),l("span",de,h(e.content),1)):v("",!0),e.type!="server"?(o(),l("a",{key:1,class:"username",href:"/user/"+e.username},h(e.username),9,pe)):v("",!0),a("span",ve,[z(h(R(e.createdAt))+" ",1),e.type!="server"?(o(),l("span",he,"@ "+h(e.server),1)):v("",!0)])]),e.type!="server"?(o(),l("p",fe,h(e.content),1)):v("",!0)],10,ce))),128))]),_:1})],544)]),b.value?(o(),l("div",me,[M(a("input",{type:"text",placeholder:"输入消息...",rows:"1","onUpdate:modelValue":s[0]||(s[0]=e=>P(c)?c.value=e:c=e),maxlength:"128",class:"message-input"},null,512),[[U,A(c)]]),a("button",{class:"send-button",onClick:s[1]||(s[1]=e=>q())},s[5]||(s[5]=[a("svg",{fill:"#ffffff",height:"30px",width:"30px",version:"1.1",id:"Capa_1",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 495.003 495.003","xml:space":"preserve"},[a("g",{id:"XMLID_51_"},[a("path",{id:"XMLID_53_",d:`M164.711,456.687c0,2.966,1.647,5.686,4.266,7.072c2.617,1.385,5.799,1.207,8.245-0.468l55.09-37.616
		l-67.6-32.22V456.687z`}),a("path",{id:"XMLID_52_",d:`M492.431,32.443c-1.513-1.395-3.466-2.125-5.44-2.125c-1.19,0-2.377,0.264-3.5,0.816L7.905,264.422
		c-4.861,2.389-7.937,7.353-7.904,12.783c0.033,5.423,3.161,10.353,8.057,12.689l125.342,59.724l250.62-205.99L164.455,364.414
		l156.145,74.4c1.918,0.919,4.012,1.376,6.084,1.376c1.768,0,3.519-0.322,5.186-0.977c3.637-1.438,6.527-4.318,7.97-7.956
		L494.436,41.257C495.66,38.188,494.862,34.679,492.431,32.443z`})])],-1)]))])):v("",!0),b.value?v("",!0):(o(),l("div",ge,[M(a("input",{type:"text",placeholder:"登录后方可发送消息!",disabled:"",rows:"1","onUpdate:modelValue":s[2]||(s[2]=e=>P(c)?c.value=e:c=e),maxlength:"128",class:"message-input"},null,512),[[U,A(c)]])]))],64))}};export{xe as default};
